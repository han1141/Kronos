<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ECharts</title>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/utc.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.0/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/plugin/timezone.js"></script>
    <style>
      body {
        font-family: "Arial", sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .file-input-section {
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 5px;
      }

      .file-input-section label {
        display: block;
        margin-bottom: 10px;
        font-weight: bold;
        color: #333;
      }

      .file-input-section input[type="file"] {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      #main {
        width: 100%;
        height: 600px;
        border: 1px solid #e0e0e0;
        border-radius: 5px;
      }

      .error-message {
        color: #dc3545;
        background: #f8d7da;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
        <input type="file" id="csvFile" accept=".csv" />
        <div id="errorMessage" class="error-message"></div>
      </div>
      <div id="main"></div>
    </div>

    <script type="text/javascript">
      const CHART_CONFIG = {
        COLORS: {
          UP: "#ef232a",
          DOWN: "#14b143",
          MAIN: ["#c23531", "#2f4554"],
        },
        LAYOUT: {
          MAIN_GRID: {
            left: "10%",
            right: "8%",
            height: "50%",
          },
          VOLUME_GRID: {
            left: "10%",
            right: "8%",
            top: "65%",
            height: "16%",
          },
        },
      };
      let myChart = null;
      const fileInput = document.getElementById("csvFile");
      const errorMessage = document.getElementById("errorMessage");
      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = "block";
        console.error(message);
      }
      function hideError() {
        errorMessage.style.display = "none";
      }
      function validateData(data) {
        if (!data || data.length === 0) {
          showError("CSV文件为空或格式不正确");
          return false;
        }
        const requiredFields = [
          "open",
          "high",
          "low",
          "close",
          "volume",
          "timestamps",
        ];
        const firstRow = data[0];
        for (const field of requiredFields) {
          if (!(field in firstRow)) {
            showError(`CSV文件缺少必需字段: ${field}`);
            return false;
          }
        }
        return true;
      }
      function processChartData(rawData) {
        console.log("开始处理数据，共", rawData.length, "条记录");
        const kLineData = [];
        const volumeData = [];
        const timeLabels = [];
        for (let i = 0; i < rawData.length; i++) {
          const row = rawData[i];
          const open = parseFloat(row.open);
          const high = parseFloat(row.high);
          const low = parseFloat(row.low);
          const close = parseFloat(row.close);
          const volume = parseFloat(row.volume);
          if (
            isNaN(open) ||
            isNaN(high) ||
            isNaN(low) ||
            isNaN(close) ||
            isNaN(volume)
          ) {
            console.warn(`第${i + 1}行数据无效，跳过处理`);
            continue;
          }
          const localTime = dayjs(row.timestamps).format('YYYY-MM-DD HH:mm:ss');
          timeLabels.push(localTime);
          kLineData.push([open, close, low, high]);
          const isUp = close >= open;
          volumeData.push({
            value: volume,
            itemStyle: {
              color: isUp ? CHART_CONFIG.COLORS.UP : CHART_CONFIG.COLORS.DOWN,
            },
          });
        }
        console.log("数据处理完成，有效数据", kLineData.length, "条");
        return {
          kLineData,
          volumeData,
          timeLabels,
        };
      }
      function createChartOption(processedData) {
        const currentDate = dayjs().format('YYYY-MM-DD HH:mm:ss');
        let currentDateIndex = -1;
        for (let i = 0; i < processedData.timeLabels.length; i++) {
          if (processedData.timeLabels[i] >= currentDate) {
            currentDateIndex = i;
            break;
          }
        }
        return {
          animation: false,
          color: CHART_CONFIG.COLORS.MAIN,
          title: {
            text: "K线与成交量展示",
            left: "center",
            textStyle: {
              fontSize: 18,
              fontWeight: "bold",
            },
          },
          legend: {
            data: ["K线", "成交量"],
            top: 30,
          },
          tooltip: {
            trigger: "axis",
            axisPointer: {
              type: "cross",
            },
            borderWidth: 1,
            borderColor: "#ccc",
            padding: 10,
            textStyle: {
              color: "#000",
            },
            formatter: function (params) {
              let result = params[0].name + "<br/>";
              if (params[0] && params[0].data) {
                const kData = params[0].data;
                result += `开盘: ${kData[1]}<br/>`;
                result += `收盘: ${kData[2]}<br/>`;
                result += `最低: ${kData[3]}<br/>`;
                result += `最高: ${kData[4]}<br/>`;
              }
              if (params[1] && params[1].data) {
                result += `成交量: ${params[1].data.value}`;
              }

              return result;
            },
          },
          axisPointer: {
            link: [{ xAxisIndex: "all" }],
            label: {
              backgroundColor: "#777",
            },
          },
          grid: [
            CHART_CONFIG.LAYOUT.MAIN_GRID,
            CHART_CONFIG.LAYOUT.VOLUME_GRID,
          ],
          xAxis: [
            {
              type: "category",
              data: processedData.timeLabels,
              scale: true,
              boundaryGap: false,
              axisLine: { onZero: false },
              splitLine: { show: false },
              min: "dataMin",
              max: "dataMax",
            },
            {
              type: "category",
              gridIndex: 1,
              data: processedData.timeLabels,
              scale: true,
              boundaryGap: false,
              axisLine: { onZero: false },
              axisTick: { show: false },
              splitLine: { show: false },
              axisLabel: { show: false },
              min: "dataMin",
              max: "dataMax",
            },
          ],
          yAxis: [
            {
              scale: true,
              splitArea: { show: true },
            },
            {
              scale: true,
              gridIndex: 1,
              axisLabel: { show: false },
              axisLine: { show: false },
              axisTick: { show: false },
              splitLine: { show: false },
            },
          ],
          dataZoom: [
            {
              type: "inside",
              xAxisIndex: [0, 1],
              start: 0,
              end: 100,
            },
            {
              show: true,
              type: "slider",
              xAxisIndex: [0, 1],
              top: "90%",
              start: 0,
              end: 100,
            },
          ],
          series: [
            {
              name: "K线",
              type: "candlestick",
              data: processedData.kLineData,
              itemStyle: {
                color: CHART_CONFIG.COLORS.UP,
                color0: CHART_CONFIG.COLORS.DOWN,
                borderColor: CHART_CONFIG.COLORS.UP,
                borderColor0: CHART_CONFIG.COLORS.DOWN,
              },
              markLine: currentDateIndex >= 0 ? {
                symbol: ['none', 'none'],
                data: [
                  {
                    name: '当前日期',
                    xAxis: currentDateIndex,
                    lineStyle: {
                      color: '#ff6b35',
                      width: 2,
                      type: 'dashed'
                    },
                    label: {
                      show: true,
                      position: 'insideEndTop',
                      formatter: '当前日期',
                      color: '#ff6b35',
                      fontSize: 12,
                      fontWeight: 'bold'
                    }
                  }
                ]
              } : undefined,
            },
            {
              name: "成交量",
              type: "bar",
              xAxisIndex: 1,
              yAxisIndex: 1,
              data: processedData.volumeData,
              barWidth: "60%",
            },
          ],
        };
      }
      function renderChart(processedData) {
        try {
          const option = createChartOption(processedData);
          myChart.setOption(option, true);
          hideError();
          console.log("图表渲染成功");
        } catch (error) {
          showError("图表渲染失败: " + error.message);
        }
      }
      function handleCSVFile(file) {
        if (!file) {
          showError("请选择一个CSV文件");
          return;
        }
        const reader = new FileReader();
        reader.onload = function (event) {
          try {
            const csvText = event.target.result;
            console.log("CSV文件读取成功");
            const parseResult = Papa.parse(csvText, {
              header: true,
              skipEmptyLines: true,
              dynamicTyping: false,
            });
            if (parseResult.errors.length > 0) {
              showError("CSV解析错误: " + parseResult.errors[0].message);
              return;
            }
            const rawData = parseResult.data;
            console.log("CSV解析完成，共", rawData.length, "行数据");
            if (!validateData(rawData)) {
              return;
            }
            const processedData = processChartData(rawData);
            if (processedData.kLineData.length === 0) {
              showError("没有有效的数据可以显示");
              return;
            }
            renderChart(processedData);
          } catch (error) {
            showError("文件处理失败: " + error.message);
          }
        };
        reader.onerror = function () {
          showError("文件读取失败");
        };
        reader.readAsText(file, "UTF-8");
      }
      function initializeApp() {
        try {
          dayjs.extend(dayjs_plugin_utc);
          dayjs.extend(dayjs_plugin_timezone);
          myChart = echarts.init(document.getElementById("main"));
          window.addEventListener("resize", function () {
            if (myChart) {
              myChart.resize();
            }
          });
          fileInput.addEventListener("change", function (event) {
            const file = event.target.files[0];
            handleCSVFile(file);
          });
          console.log("应用初始化完成");
        } catch (error) {
          showError("应用初始化失败: " + error.message);
        }
      }
      document.addEventListener("DOMContentLoaded", initializeApp);
    </script>
  </body>
</html>
